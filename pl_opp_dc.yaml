---
- hosts: localhost
  roles:
         # Loads library/openshift.py to make it available to other plays;
         # does nothing else by itself
         - { role: epfl_idevelop.ansible_module_openshift }

- hosts: localhost
  vars:
    replicas: 1
    dbip: 128.179.178.87
    dbname: db1
    appname: opp-app
  tasks:
    - name: "deployment config"
      openshift:
        state: "{{state}}"
        kind: DeploymentConfig
        name: "{{app_name}}"
        namespace: "myproject"
        content: |
            apiVersion: apps.openshift.io/v1
            kind: DeploymentConfig
            metadata:
              labels:
                run: {{app_name}}
              name: {{app_name}}
              namespace: myproject

            spec:
              replicas: {{replicas}}
              revisionHistoryLimit: 10
              selector:
                run: {{app_name}}
              template:
                metadata:
                  labels:
                    run: {{app_name}}
                spec:
                  containers:
                    - env:
                        - name: DATABASE_URL
                          value: 'mysql2://root:root!@{{db_ip}}:3306/{{db_name}}'
                      image: 'openproject/community:9'
                      name: {{app_name}}
                      volumeMounts:
                        - mountPath: /usr/share/ops
                          name: nfsvol-2
                  volumes:
                    - name: nfsvol-2
                      persistentVolumeClaim:
                        claimName: nfs-pvc
              triggers:
                - type: ConfigChange
