- hosts: localhost
  roles:
         # Loads library/openshift.py to make it available to other plays;
         # does nothing else by itself
         - { role: epfl_idevelop.ansible_module_openshift }

- hosts: localhost
  vars:
    replicas: 1
  tasks:
    - name: "Route"
      openshift:
        state: "{{state}}"
        kind: Route
        name: "nginx-route"
        namespace: "myproject"
        content: |
            apiVersion: v1
            kind: Route
            metadata:
                name: "{{depl_name}}"
            spec:
                host: "{{depl_name}}-myproject.192.168.99.100.nip.io"
                port:
                    targetPort: 80
                to:
                    kind: Service
                    name: "{{depl_name}}"

    - name: "deployment config"
      openshift:
        state: "{{state}}"
        kind: DeploymentConfig
        name: "nginx-dep1"
        namespace: "myproject"
        content: |
            kind: "DeploymentConfig"
            apiVersion: "v1"
            metadata:
                name: "{{depl_name}}"
                labels:
                    run: "{{depl_name}}"
                namespace: myproject
            spec:
                template:
                    metadata:
                        labels:
                            run: "{{depl_name}}"
                    spec:
                        containers:
                            - name: helloworld
                              image: nginx
                              ports:
                                - containerPort: 80
                                  protocol: "TCP"
                replicas: "{{replicas}}"
                selector:
                    run: "{{depl_name}}"
                triggers:
                    - type: "ConfigChange"

    - name: "Service"
      openshift:
        state: "{{state}}"
        kind: Service
        name: "nginx-svc"
        namespace: "myproject"
        content: |
            apiVersion: v1
            kind: Service
            metadata:
                name: "{{depl_name}}"
                labels:
                   run: "{{depl_name}}"
                namespace: myproject
            spec:
                selector:
                   run: "{{depl_name}}"
                ports:
                - port: 80
                  protocol: TCP
                  targetPort: 80
